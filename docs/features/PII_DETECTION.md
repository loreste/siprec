# PII Detection and Redaction

SIPREC Server provides comprehensive Personally Identifiable Information (PII) detection and redaction capabilities for both transcriptions and audio recordings. This feature helps organizations comply with privacy regulations and protect sensitive information.

## Overview

The PII detection system automatically identifies and redacts sensitive information in real-time during call processing. It supports multiple types of PII data and provides both transcription filtering and audio timeline marking for post-processing.

## Supported PII Types

### Social Security Numbers (SSN)
- **Pattern**: XXX-XX-XXXX format and variations
- **Validation**: Area code, group number, and serial number validation
- **Example**: `123-45-6789` → `***-**-****`

### Credit Card Numbers
- **Pattern**: Various formats (Visa, MasterCard, American Express, Discover)
- **Validation**: Luhn algorithm checksum validation
- **Example**: `4111-1111-1111-1111` → `****-****-****-****`

### Phone Numbers
- **Pattern**: US phone number formats
- **Example**: `(555) 123-4567` → `(***) ***-****`

### Email Addresses
- **Pattern**: Standard email formats
- **Example**: `user@example.com` → `****@*******.***`

## Configuration

### Environment Variables

```env
# Enable PII detection
PII_DETECTION_ENABLED=true

# Specify which types to detect (comma-separated)
PII_ENABLED_TYPES=ssn,credit_card,phone,email

# Character used for redaction
PII_REDACTION_CHAR=*

# Apply PII filtering to transcriptions
PII_APPLY_TO_TRANSCRIPTIONS=true

# Apply PII marking to audio recordings
PII_APPLY_TO_RECORDINGS=true

# Preserve original format when redacting
PII_PRESERVE_FORMAT=true

# Context characters around detected PII
PII_CONTEXT_LENGTH=10
```

### Configuration File

```yaml
pii:
  enabled: true
  enabled_types:
    - ssn
    - credit_card
    - phone
    - email
  redaction_char: "*"
  apply_to_transcriptions: true
  apply_to_recordings: true
  preserve_format: true
  context_length: 10
```

## How It Works

### Transcription PII Detection

1. **Real-time Processing**: As transcriptions are generated by STT providers, they pass through the PII detection filter
2. **Pattern Matching**: Regular expressions identify potential PII data
3. **Validation**: Advanced validation ensures only valid PII is flagged (e.g., Luhn algorithm for credit cards)
4. **Redaction**: Detected PII is replaced with redaction characters while preserving format
5. **Metadata**: Original text and PII type information is preserved in metadata

### Audio PII Marking

1. **Timeline Correlation**: PII detection events from transcriptions are correlated with audio timestamps
2. **Marker Creation**: Audio timeline markers are created for each PII detection event
3. **Post-processing Ready**: Markers provide the data needed for audio redaction tools

## API Integration

### Transcription Flow

```
STT Provider → PII Filter → [WebSocket, AMQP, Audio Marker]
```

When PII is detected in transcriptions:
- Redacted transcription is sent to WebSocket clients
- Filtered transcription is sent to AMQP queue
- Audio timeline marker is created for post-processing

### Metadata Structure

Transcriptions with detected PII include metadata:

```json
{
  "pii_detected": true,
  "pii_types": ["ssn", "credit_card"],
  "original_transcription": "My SSN is 123-45-6789",
  "redacted_transcription": "My SSN is ***-**-****"
}
```

## Audio Timeline Markers

### Marker Format

```json
{
  "timestamp": "2024-01-01T12:00:00Z",
  "pii_type": "ssn",
  "original_text": "123-45-6789",
  "redacted_text": "***-**-****",
  "is_final": true,
  "offset_ms": 15750
}
```

### Post-processing Integration

Audio markers can be used by post-processing tools to:
- Apply audio beeping or silence over PII segments
- Generate compliance reports
- Create audit trails for PII handling

## Security Considerations

### Data Handling
- Original PII data is only stored temporarily in memory
- Redacted versions are persisted to storage
- Audio markers contain redacted information only

### Compliance
- Configurable to meet various regulatory requirements
- Audit logging of PII detection events
- Flexible redaction policies

### Performance
- Real-time processing with minimal latency impact
- Efficient pattern matching algorithms
- Memory-optimized processing pipeline

## Monitoring and Metrics

### Metrics Available
- `pii_detections_total` - Total PII detections by type
- `pii_processing_duration` - Processing time for PII detection
- `pii_redaction_errors_total` - Failed redaction attempts

### Logging
- PII detection events are logged (with redacted content)
- Audio marker creation events
- Configuration changes and errors

## Best Practices

### Configuration
1. **Enable Gradually**: Start with one PII type and expand
2. **Test Thoroughly**: Validate detection accuracy with your data
3. **Monitor Performance**: Watch for latency impact on transcriptions

### Deployment
1. **Secure Configuration**: Protect PII configuration settings
2. **Audit Regularly**: Review PII detection logs
3. **Update Patterns**: Keep detection patterns current

### Integration
1. **Post-processing Pipeline**: Set up audio redaction tools
2. **Compliance Reporting**: Use markers for audit trails
3. **Quality Assurance**: Regularly review redaction accuracy

## Troubleshooting

### Common Issues

#### False Positives
- Adjust context length to improve accuracy
- Fine-tune pattern matching for your use case
- Use validation algorithms to reduce false matches

#### Performance Impact
- Monitor transcription latency
- Adjust processing timeouts if needed
- Consider selective PII type enabling

#### Audio Marker Issues
- Verify PII audio marking is enabled
- Check RTP forwarder initialization
- Review transcription service integration

### Debug Logging

Enable debug logging for PII detection:

```env
LOG_LEVEL=debug
```

This will provide detailed information about:
- PII pattern matching
- Validation results
- Audio marker creation
- Performance metrics

## Advanced Features

### Custom PII Types
The system is designed to be extensible for custom PII patterns. Contact support for custom PII type implementation.

### Integration with External Systems
- Export PII detection events to external security systems
- Integration with data loss prevention (DLP) tools
- Custom webhook notifications for PII events

### Compliance Reporting
- Generate reports on PII detection frequency
- Audit trails for regulatory compliance
- Integration with compliance management systems